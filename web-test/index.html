<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkBitch - Avatar Chat Test</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .avatar-section {
            flex: 1;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .avatar-container {
            width: 300px;
            height: 400px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        #avatar-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 15px;
        }

        .avatar-placeholder {
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }

        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        .avatar-url-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .load-avatar-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .load-avatar-btn:hover {
            background: #0056b3;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .chat-header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            color: #6c757d;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user {
            align-self: flex-end;
            background: #007bff;
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .message.system {
            align-self: center;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            font-style: italic;
            text-align: center;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #007bff;
        }

        .send-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: #0056b3;
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 10px;
            display: inline-block;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 18px;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                width: 95%;
                height: 95vh;
            }

            .avatar-section {
                flex: 0 0 auto;
                padding: 15px;
            }

            .avatar-container {
                width: 200px;
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="avatar-section">
            <div class="avatar-container" id="avatarContainer">
                <div class="avatar-placeholder">
                    <h3>Ready Player Me Avatar</h3>
                    <p>Enter your avatar URL below to load your 3D avatar</p>
                </div>
            </div>
            <div class="avatar-controls">
                <input
                    type="text"
                    class="avatar-url-input"
                    id="avatarUrl"
                    placeholder="Paste your .glb avatar URL here"
                    value="https://models.readyplayer.me/68ea9e6ec138a9c842570bf9.glb"
                >
                <button class="load-avatar-btn" onclick="loadAvatar()">Load Avatar</button>
                <button class="load-avatar-btn" onclick="createAvatar()" style="background: #28a745;">Create New Avatar</button>
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h1>
                    <span class="status-indicator" id="statusIndicator"></span>
                    TalkBitch Chat
                </h1>
                <p>Chat with your Ready Player Me avatar powered by OpenAI</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    Welcome! Load your avatar and start chatting. Your avatar will come to life with AI conversations.
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                AI is thinking...
            </div>

            <div class="chat-input">
                <div class="input-container">
                    <input
                        type="text"
                        class="message-input"
                        id="messageInput"
                        placeholder="Type your message here..."
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Load from config.js (not committed to repo)
        if (!window.CONFIG) {
            console.error('Config not loaded! Please create config.js from config.example.js');
            alert('Setup required: Please create config.js from config.example.js with your API keys');
        }

        const OPENAI_API_KEY = window.CONFIG?.OPENAI_API_KEY || '';
        const RPM_SUBDOMAIN = window.CONFIG?.RPM_SUBDOMAIN || '';
        const RPM_APP_ID = window.CONFIG?.RPM_APP_ID || '';

        // State
        let conversationHistory = [
            {
                role: 'system',
                content: 'You are a Ready Player Me avatar, who exists in the metaverse. You are friendly, engaging, and love to chat about virtual worlds, avatars, and digital experiences. Keep responses conversational and not too long.'
            }
        ];

        let isConnected = false;
        let currentModel = 'gpt-5'; // Start with GPT-5, fallback to others if needed
        const availableModels = ['gpt-5', 'gpt-4o', 'gpt-4o-mini', 'gpt-3.5-turbo'];

        // Rate limiting state
        let requestQueue = [];
        let isProcessingQueue = false;
        let lastRequestTime = 0;
        const REQUEST_INTERVAL = 20000; // 20 seconds between requests for free tier (3 per minute)

        // DOM Elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const typingIndicator = document.getElementById('typingIndicator');

        // Initialize
        window.onload = function() {
            testConnection();
            addMessage('ai', 'Hello! I\'m your Ready Player Me avatar. Load your avatar above and let\'s start chatting!');
        };

        // Test OpenAI connection
        async function testConnection() {
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    isConnected = true;
                    statusIndicator.classList.add('connected');
                    addMessage('system', 'OpenAI connection established successfully!');
                } else {
                    throw new Error('API key validation failed');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                addMessage('system', 'Warning: OpenAI connection failed. Check your API key.');
            }
        }

        // Load Ready Player Me Avatar
        function loadAvatar() {
            const avatarUrl = document.getElementById('avatarUrl').value.trim();
            if (!avatarUrl) {
                addMessage('system', 'Please enter a valid Ready Player Me avatar URL');
                return;
            }

            const avatarContainer = document.getElementById('avatarContainer');

            // Check if it's a .glb URL (actual avatar model)
            if (avatarUrl.includes('.glb')) {
                // Create model viewer for the actual 3D model
                const modelViewer = document.createElement('model-viewer');
                modelViewer.src = avatarUrl;
                modelViewer.alt = 'Ready Player Me Avatar';
                modelViewer.style.width = '100%';
                modelViewer.style.height = '100%';
                modelViewer.setAttribute('camera-controls', '');
                modelViewer.setAttribute('environment-image', 'neutral');
                modelViewer.setAttribute('shadow-intensity', '1');
                modelViewer.setAttribute('camera-orbit', '0deg 75deg 1.5m');
                modelViewer.setAttribute('field-of-view', '30deg');
                modelViewer.setAttribute('min-camera-orbit', 'auto 50deg auto');
                modelViewer.setAttribute('max-camera-orbit', 'auto 100deg auto');
                modelViewer.setAttribute('camera-target', '0m 1.6m 0m');

                avatarContainer.innerHTML = '';
                avatarContainer.appendChild(modelViewer);

                addMessage('system', 'Avatar model loaded! This is your actual 3D avatar.');
            } else {
                // If not a .glb URL, treat as Ready Player Me creation URL
                const iframe = document.createElement('iframe');
                iframe.id = 'avatar-iframe';
                iframe.src = avatarUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '15px';

                avatarContainer.innerHTML = '';
                avatarContainer.appendChild(iframe);

                addMessage('system', 'Ready Player Me creator loaded. Create your avatar, then copy the .glb URL!');
            }
        }

        // Create new Ready Player Me avatar
        function createAvatar() {
            const avatarContainer = document.getElementById('avatarContainer');

            // Use your Ready Player Me subdomain credentials
            const creatorUrl = `https://${RPM_SUBDOMAIN}.readyplayer.me/avatar?frameApi`;

            const iframe = document.createElement('iframe');
            iframe.id = 'avatar-creator';
            iframe.src = creatorUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '15px';

            avatarContainer.innerHTML = '';
            avatarContainer.appendChild(iframe);

            addMessage('system', 'Ready Player Me creator loaded! Create your avatar, then copy the .glb URL when finished.');

            // Listen for avatar creation completion
            window.addEventListener('message', function(event) {
                if (event.data?.eventName === 'v1.avatar.exported') {
                    const avatarUrl = event.data.url;
                    document.getElementById('avatarUrl').value = avatarUrl;
                    addMessage('system', `Avatar created! URL copied to input field. Click "Load Avatar" to use it.`);
                }
            });
        }

        // Handle keyboard input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message with rate limiting
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message immediately
            addMessage('user', message);
            messageInput.value = '';

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Queue the API request
            queueAPIRequest(message);
        }

        // Queue system for rate limiting
        function queueAPIRequest(message) {
            requestQueue.push(message);

            if (!isProcessingQueue) {
                processQueue();
            } else {
                addMessage('system', `Request queued. ${requestQueue.length} requests ahead of you.`);
            }
        }

        // Process queued requests with rate limiting
        async function processQueue() {
            if (requestQueue.length === 0) {
                isProcessingQueue = false;
                return;
            }

            isProcessingQueue = true;

            // Check if we need to wait
            const timeSinceLastRequest = Date.now() - lastRequestTime;
            if (timeSinceLastRequest < REQUEST_INTERVAL) {
                const waitTime = REQUEST_INTERVAL - timeSinceLastRequest;
                const waitSeconds = Math.ceil(waitTime / 1000);

                addMessage('system', `Rate limit: waiting ${waitSeconds} seconds before next request...`);

                setTimeout(() => {
                    processQueue();
                }, waitTime);
                return;
            }

            // Process the next request
            const currentMessage = requestQueue.shift();

            // Disable input while processing
            messageInput.disabled = true;
            sendBtn.disabled = true;

            // Show typing indicator
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: conversationHistory,
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                    } else if (response.status === 401) {
                        throw new Error('API key invalid. Please check your OpenAI API key.');
                    } else if (response.status === 404) {
                        // Try fallback to next available model
                        const currentIndex = availableModels.indexOf(currentModel);
                        if (currentIndex < availableModels.length - 1) {
                            currentModel = availableModels[currentIndex + 1];
                            addMessage('system', `${availableModels[currentIndex]} not available, trying ${currentModel}...`);
                            // Retry with new model
                            processQueue();
                            return;
                        } else {
                            throw new Error('No available models found for your account tier.');
                        }
                    } else {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                }

                const data = await response.json();
                const reply = data.choices[0].message.content;

                // Add AI response
                addMessage('ai', reply);

                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: reply
                });

                // Simulate avatar talking animation
                simulateAvatarTalking();

            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('Rate limit')) {
                    addMessage('system', 'Too many requests! Please wait 30 seconds and try again.');
                } else if (error.message.includes('API key')) {
                    addMessage('system', 'API key issue. Please check your OpenAI account.');
                } else {
                    addMessage('system', `Error: ${error.message}`);
                }
            } finally {
                // Update last request time
                lastRequestTime = Date.now();

                // Hide typing indicator and re-enable input
                typingIndicator.style.display = 'none';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();

                // Process next item in queue after a delay
                setTimeout(() => {
                    processQueue();
                }, 1000);
            }
        }

        // Add message to chat
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = content;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Simulate avatar talking animation
        function simulateAvatarTalking() {
            const avatarContainer = document.getElementById('avatarContainer');
            avatarContainer.style.transform = 'scale(1.05)';
            avatarContainer.style.transition = 'transform 0.3s ease';

            setTimeout(() => {
                avatarContainer.style.transform = 'scale(1)';
            }, 2000);
        }

        // Sample avatar URLs for testing
        const sampleAvatars = [
            'https://models.readyplayer.me/68ea9e6ec138a9c842570bf9.glb',
            'https://models.readyplayer.me/632d65e99aa4cf6dd5c64e7c.glb'
        ];

        // Auto-load first sample avatar on page load
        setTimeout(() => {
            if (document.getElementById('avatarUrl').value) {
                loadAvatar();
            }
        }, 1000);
    </script>
</body>
</html>